<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mice Development Team">
<meta name="dcterms.date" content="2024-06-28">

<title>mice: Imputing multi-level data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Imputing_multilevel_data_files/libs/clipboard/clipboard.min.js"></script>
<script src="Imputing_multilevel_data_files/libs/quarto-html/quarto.js"></script>
<script src="Imputing_multilevel_data_files/libs/quarto-html/popper.min.js"></script>
<script src="Imputing_multilevel_data_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Imputing_multilevel_data_files/libs/quarto-html/anchor.min.js"></script>
<link href="Imputing_multilevel_data_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Imputing_multilevel_data_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Imputing_multilevel_data_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Imputing_multilevel_data_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Imputing_multilevel_data_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#inspection-of-the-incomplete-data" id="toc-inspection-of-the-incomplete-data" class="nav-link active" data-scroll-target="#inspection-of-the-incomplete-data">Inspection of the incomplete data</a></li>
  <li><a href="#checking-convergence-of-the-imputations" id="toc-checking-convergence-of-the-imputations" class="nav-link" data-scroll-target="#checking-convergence-of-the-imputations">Checking Convergence of the imputations</a></li>
  <li><a href="#changing-the-imputation-method" id="toc-changing-the-imputation-method" class="nav-link" data-scroll-target="#changing-the-imputation-method">Changing the imputation method</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><code>mice</code>: Imputing multi-level data</h1>
<p class="subtitle lead"><strong>Vignette 6 of 10</strong></p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><strong>Mice Development Team</strong> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 28, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>



<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
  }
td {  /* Table  */
  font-size: 14px;
}
h1.title {
  font-size: 28px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 18px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>
<hr>
<p>This is the sixth vignette in a series of ten.</p>
<p>In this vignette we will focus on multi-level imputation. You need to have package <code>pan</code> installed. You can install it by running: <code>install.packages("pan")</code>.</p>
<hr>
<p><strong>1. Open <code>R</code> and load the packages <code>mice</code>, <code>lattice</code> and <code>pan</code>.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(mice)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(lattice)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(pan)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We choose seed value <code>123</code>. This is an arbitrary value; any value would be an equally good seed value. Fixing the random seed enables you (and others) to exactly replicate anything that involves random number generators. If you set the seed in your <code>R</code> instance to <code>123</code>, you will get the exact same results and plots as we present in this document.</p>
<hr>
<p>We are going to work with the popularity data from Joop Hox (2010). The variables in this data set are described as follows:</p>
<table class="table">
<tbody>
<tr class="odd">
<td><strong>pupil</strong></td>
<td>Pupil number within class</td>
</tr>
<tr class="even">
<td><strong>class</strong></td>
<td>Class number</td>
</tr>
<tr class="odd">
<td><strong>extrav</strong></td>
<td>Pupil extraversion</td>
</tr>
<tr class="even">
<td><strong>sex</strong></td>
<td>Pupil gender</td>
</tr>
<tr class="odd">
<td><strong>texp</strong></td>
<td>Teacher experience (years)</td>
</tr>
<tr class="even">
<td><strong>popular</strong></td>
<td>Pupil popularity</td>
</tr>
<tr class="odd">
<td><strong>popteach</strong></td>
<td>Teacher popularity</td>
</tr>
</tbody>
</table>
<hr>
<section id="inspection-of-the-incomplete-data" class="level3">
<h3 class="anchored" data-anchor-id="inspection-of-the-incomplete-data">Inspection of the incomplete data</h3>
<hr>
<p><strong>1. Open the <code>popular.RData</code> workspace.</strong> A workspace with complete and incomplete versions of the popularity data <a href="https://www.gerkovink.com/mimp/popular.RData">can be obtained here</a> or can be loaded into the Global Environment by running:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">url</span>(<span class="st">"https://www.gerkovink.com/mimp/popular.RData"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This workspace contains several datasets and functions that, when loaded, are available to you in R. If you’d like to see what is inside: run the following code</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "con"                      "icc"                     
[3] "mice.impute.2lonly.mean2" "popMCAR"                 
[5] "popMCAR2"                 "popNCR"                  
[7] "popNCR2"                  "popNCR3"                 
[9] "popular"                 </code></pre>
</div>
</div>
<p>The dataset <code>popNCR</code> is a variation on the Hox (2010) data, where the missingness in the variables is either missing at random (MAR) or missing not at random (MNAR).</p>
<hr>
<p><strong>2. Check with the functions <code>head()</code>, <code>dim()</code> - alternatively one could use <code>nrow()</code> and <code>ncol()</code> instead of <code>dim()</code> - and <code>summary()</code> how large the dataset is, of which variables the data frame consists and if there are missing values in a variable.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  pupil class extrav  sex texp popular popteach
1     1     1      5    1   NA     6.3       NA
2     2     1     NA    0   24     4.9       NA
3     3     1      4    1   NA     5.3        6
4     4     1      3 &lt;NA&gt;   NA     4.7        5
5     5     1      5    1   24      NA        6
6     6     1     NA    0   NA     4.7        5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2000    7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ncol</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     pupil           class          extrav         sex           texp     
 Min.   : 1.00   17     :  26   Min.   : 1.000   0   :661   Min.   : 2.0  
 1st Qu.: 6.00   63     :  25   1st Qu.: 4.000   1   :843   1st Qu.: 7.0  
 Median :11.00   10     :  24   Median : 5.000   NA's:496   Median :12.0  
 Mean   :10.65   15     :  24   Mean   : 5.313              Mean   :11.8  
 3rd Qu.:16.00   4      :  23   3rd Qu.: 6.000              3rd Qu.:16.0  
 Max.   :26.00   21     :  23   Max.   :10.000              Max.   :25.0  
                 (Other):1855   NA's   :516                 NA's   :976   
    popular         popteach     
 Min.   :0.000   Min.   : 1.000  
 1st Qu.:3.900   1st Qu.: 4.000  
 Median :4.800   Median : 5.000  
 Mean   :4.829   Mean   : 4.834  
 3rd Qu.:5.800   3rd Qu.: 6.000  
 Max.   :9.100   Max.   :10.000  
 NA's   :510     NA's   :528     </code></pre>
</div>
</div>
<p>The data set has 2000 rows and 7 columns (variables). The variables <code>extrav</code>, <code>sex</code>, <code>texp</code>, <code>popular</code> and <code>popteach</code> contain missing values. About a quarter of these variables is missing, except for <code>texp</code> where 50 % is missing.</p>
<hr>
<p><strong>3. As we have seen before, the function <code>md.pattern()</code> is used to display all different missing data patterns. How many different missing data patterns are present in the <code>popNCR</code> dataframe and which patterns occur most frequently in the data? Also find out how many patterns we would observe when variable <code>texp</code> (teacher experience) is not considered.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">md.pattern</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    pupil class sex popular extrav popteach texp     
308     1     1   1       1      1        1    1    0
279     1     1   1       1      1        1    0    1
110     1     1   1       1      1        0    1    1
115     1     1   1       1      1        0    0    2
114     1     1   1       1      0        1    1    1
98      1     1   1       1      0        1    0    2
33      1     1   1       1      0        0    1    2
24      1     1   1       1      0        0    0    3
119     1     1   1       0      1        1    1    1
113     1     1   1       0      1        1    0    2
50      1     1   1       0      1        0    1    2
75      1     1   1       0      1        0    0    3
29      1     1   1       0      0        1    1    2
21      1     1   1       0      0        1    0    3
2       1     1   1       0      0        0    1    3
14      1     1   1       0      0        0    0    4
102     1     1   0       1      1        1    1    1
89      1     1   0       1      1        1    0    2
25      1     1   0       1      1        0    1    2
29      1     1   0       1      1        0    0    3
85      1     1   0       1      0        1    1    2
56      1     1   0       1      0        1    0    3
9       1     1   0       1      0        0    1    3
14      1     1   0       1      0        0    0    4
19      1     1   0       0      1        1    1    2
27      1     1   0       0      1        1    0    3
13      1     1   0       0      1        0    1    3
11      1     1   0       0      1        0    0    4
4       1     1   0       0      0        1    1    3
9       1     1   0       0      0        1    0    4
2       1     1   0       0      0        0    1    4
2       1     1   0       0      0        0    0    5
        0     0 496     510    516      528  976 3026</code></pre>
</div>
</div>
<p>There are 32 unique patterns. The pattern where everything is observed and the pattern where only texp is missing occur most frequently.</p>
<p>If we omit texp, then the following pattern matrix is realized:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">md.pattern</span>(popNCR[ , <span class="sc">-</span><span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    pupil class sex popular extrav popteach     
587     1     1   1       1      1        1    0
225     1     1   1       1      1        0    1
212     1     1   1       1      0        1    1
57      1     1   1       1      0        0    2
232     1     1   1       0      1        1    1
125     1     1   1       0      1        0    2
50      1     1   1       0      0        1    2
16      1     1   1       0      0        0    3
191     1     1   0       1      1        1    1
54      1     1   0       1      1        0    2
141     1     1   0       1      0        1    2
23      1     1   0       1      0        0    3
46      1     1   0       0      1        1    2
24      1     1   0       0      1        0    3
13      1     1   0       0      0        1    3
4       1     1   0       0      0        0    4
        0     0 496     510    516      528 2050</code></pre>
</div>
</div>
<p>Without texp, there are only 16 patterns.</p>
<hr>
<p><strong>4. Let’s focus more precisely on the missing data patterns. Does the missing data of <code>popular</code> depend on <code>popteach</code>? One could for example check this by making a histogram of <code>popteach</code> separately for the pupils with known popularity and missing popularity.</strong></p>
<p>In R the missingness indicator</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.na</span>(popNCR<span class="sc">$</span>popular)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   [1] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE
  [13] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE
  [25] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
  [37]  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
  [49] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
  [61] FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE
  [73] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE
  [85] FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE
  [97] FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
 [109] FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE  TRUE
 [121] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [133]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
 [145] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [157]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [169]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
 [181] FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [193]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE
 [205] FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE
 [217]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [229] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [241] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE
 [253]  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE
 [265] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
 [277]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
 [289] FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE
 [301]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE
 [313] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
 [325] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE FALSE
 [337] FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [349] FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE FALSE
 [361] FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE  TRUE
 [373] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
 [385] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
 [397] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
 [409] FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [421] FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE
 [433] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE
 [445] FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE
 [457]  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE
 [469] FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
 [481] FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [493] FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE
 [505] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE
 [517] FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE
 [529] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [541] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE
 [553] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
 [565]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE  TRUE
 [577] FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE
 [589]  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
 [601] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE
 [613] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [625] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
 [637] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE
 [649]  TRUE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE  TRUE  TRUE
 [661]  TRUE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE  TRUE  TRUE  TRUE FALSE
 [673] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
 [685]  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE
 [697]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE
 [709]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
 [721] FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE
 [733] FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE
 [745] FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
 [757] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE
 [769] FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE
 [781] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE
 [793]  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE
 [805] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
 [817] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
 [829] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [841]  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
 [853] FALSE  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE
 [865] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE
 [877] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
 [889]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
 [901]  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE
 [913] FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
 [925] FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE
 [937] FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
 [949] FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
 [961] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
 [973] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE
 [985] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE
 [997]  TRUE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE
[1009] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1021] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[1033] FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE
[1045]  TRUE  TRUE FALSE  TRUE  TRUE FALSE  TRUE  TRUE FALSE FALSE  TRUE FALSE
[1057] FALSE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
[1069] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[1081]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1093] FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE
[1105] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE
[1117] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
[1129] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1141] FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE
[1153] FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
[1165] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE
[1177] FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[1189] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1201]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE
[1213] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
[1225] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE
[1237] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[1249] FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[1261] FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE
[1273]  TRUE FALSE FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE
[1285] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE
[1297] FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE
[1309] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE
[1321] FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE
[1333]  TRUE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE  TRUE
[1345] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
[1357] FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[1369] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE
[1381] FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE
[1393] FALSE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE
[1405]  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE
[1417] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE
[1429]  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[1441]  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[1453]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
[1465] FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE
[1477]  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
[1489] FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[1501]  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[1513] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE
[1525] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
[1537]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1549]  TRUE  TRUE FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE  TRUE
[1561] FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE
[1573] FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
[1585] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
[1597] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
[1609] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1621] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[1633] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1645] FALSE  TRUE  TRUE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE  TRUE  TRUE
[1657] FALSE  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE FALSE
[1669]  TRUE FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE FALSE
[1681] FALSE FALSE  TRUE  TRUE FALSE  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE
[1693] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE
[1705] FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE
[1717] FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE
[1729] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1741] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
[1753] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[1765] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
[1777] FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE
[1789]  TRUE FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE  TRUE
[1801]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
[1813] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE
[1825] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1837] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE  TRUE
[1849] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
[1861] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1873] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1885] FALSE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE  TRUE FALSE  TRUE  TRUE
[1897] FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE
[1909] FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE
[1921]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[1933]  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE
[1945] FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE  TRUE
[1957] FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE
[1969] FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE
[1981] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
[1993] FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE</code></pre>
</div>
</div>
<p>is a dummy variable of the same length as <code>popular</code> with value 0 (<code>FALSE</code>) for observed pupil popularity and 1 (<code>TRUE</code>) for missing pupil popularity. A histogram can be made with the function <code>histogram()</code>. The code for a conditional histogram of <code>popteach</code> given the missingness indicator for popular is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">histogram</span>(<span class="sc">~</span> popteach <span class="sc">|</span> <span class="fu">is.na</span>(popular), <span class="at">data=</span>popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We do see that the histogram for the missing <code>popular</code> (<code>TRUE</code>) is further to the right than the histogram for observed <code>popular</code> (<code>FALSE</code>). This would indicate a right-tailed MAR missingness. In fact this is exactly what happens, because we created the missingness in these data ourselves. But we can make it observable by examining the relations between the missingness in <code>popular</code> and the observed data in <code>popteach</code>.</p>
<hr>
<p><strong>5. Does the missingness of the other incomplete variables depend on <code>popteach</code>? If yes, what is the direction of the relation?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">histogram</span>(<span class="sc">~</span> popteach <span class="sc">|</span> <span class="fu">is.na</span>(sex), <span class="at">data =</span> popNCR)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There seems to be a left-tailed relation between <code>popteach</code> and the missingness in <code>sex</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">histogram</span>(<span class="sc">~</span> popteach <span class="sc">|</span> <span class="fu">is.na</span>(extrav), <span class="at">data =</span> popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There also seems to be a left-tailed relation between <code>popteach</code> and the missingness in <code>extrav</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">histogram</span>(<span class="sc">~</span> popteach <span class="sc">|</span> <span class="fu">is.na</span>(texp), <span class="at">data =</span> popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There seems to be no observable relation between <code>popteach</code> and the missingness in <code>texp</code>. It might be MCAR or even MNAR.</p>
<hr>
<p><strong>6. Find out if the missingness in teacher popularity depends on pupil popularity.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">histogram</span>(<span class="sc">~</span> popular <span class="sc">|</span> <span class="fu">is.na</span>(popteach), <span class="at">data =</span> popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Yes: there is a dependency. The relation seems to be right-tailed.</p>
<hr>
<p><strong>7. Have a look at the intraclass correlation (ICC) for the incomplete variables <code>popular</code>, <code>popteach</code> and <code>texp</code>.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> <span class="fu">as.factor</span>(class), <span class="at">data =</span> popNCR))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.328007</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, <span class="at">data =</span> popNCR))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3138658</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, <span class="at">data =</span> popNCR))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Please note that the function <code>icc()</code> comes from the package <code>multilevel</code> (function <code>ICC1()</code>), but is included in the workspace <code>popular.RData</code>. Write down the ICCs, you’ll need them later.</p>
<hr>
<p><strong>7b. Do you think it is necessary to take the multilevel structure into account?</strong></p>
<p>YES! There is a strong cluster structure going on. If we ignore the clustering in our imputation model, we may run into invalid inference. To stay as close to the true data model, we must take the cluster structure into account during imputation.</p>
<hr>
<p><strong>8. Impute the <code>popNCR</code> dataset with <code>mice</code> using imputation method <code>norm</code> for <code>popular</code>, <code>popteach</code>, <code>texp</code> and <code>extrav</code>. Exclude <code>class</code> as a predictor</strong> <em>for all variables</em><strong>. Call the <code>mids</code>-object <code>imp1</code>.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ini <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>meth <span class="ot">&lt;-</span> ini<span class="sc">$</span>meth</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>meth</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   pupil    class   extrav      sex     texp  popular popteach 
      ""       ""    "pmm" "logreg"    "pmm"    "pmm"    "pmm" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>meth[<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>)] <span class="ot">&lt;-</span> <span class="st">"norm"</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>meth</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   pupil    class   extrav      sex     texp  popular popteach 
      ""       ""   "norm" "logreg"   "norm"   "norm"   "norm" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> ini<span class="sc">$</span>pred</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         pupil class extrav sex texp popular popteach
pupil        0     1      1   1    1       1        1
class        1     0      1   1    1       1        1
extrav       1     1      0   1    1       1        1
sex          1     1      1   0    1       1        1
texp         1     1      1   1    0       1        1
popular      1     1      1   1    1       0        1
popteach     1     1      1   1    1       1        0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>pred[, <span class="st">"class"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>pred[, <span class="st">"pupil"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         pupil class extrav sex texp popular popteach
pupil        0     0      1   1    1       1        1
class        0     0      1   1    1       1        1
extrav       0     0      0   1    1       1        1
sex          0     0      1   0    1       1        1
texp         0     0      1   1    0       1        1
popular      0     0      1   1    1       0        1
popteach     0     0      1   1    1       1        0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>imp1 <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR, <span class="at">meth =</span> meth, <span class="at">pred =</span> pred, <span class="at">print =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><strong>9. Compare the means of the variables in the first imputed dataset and in the incomplete dataset.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">complete</span>(imp1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     pupil           class          extrav       sex           texp       
 Min.   : 1.00   17     :  26   Min.   : 1.000   0: 985   Min.   :-6.465  
 1st Qu.: 6.00   63     :  25   1st Qu.: 4.139   1:1015   1st Qu.: 8.000  
 Median :11.00   10     :  24   Median : 5.000            Median :12.253  
 Mean   :10.65   15     :  24   Mean   : 5.269            Mean   :12.509  
 3rd Qu.:16.00   4      :  23   3rd Qu.: 6.000            3rd Qu.:16.698  
 Max.   :26.00   21     :  23   Max.   :10.000            Max.   :35.745  
                 (Other):1855                                             
    popular          popteach     
 Min.   : 0.000   Min.   : 1.000  
 1st Qu.: 4.100   1st Qu.: 4.000  
 Median : 5.000   Median : 5.000  
 Mean   : 5.006   Mean   : 5.021  
 3rd Qu.: 5.971   3rd Qu.: 6.000  
 Max.   :10.547   Max.   :10.000  
                                  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     pupil           class          extrav         sex           texp     
 Min.   : 1.00   17     :  26   Min.   : 1.000   0   :661   Min.   : 2.0  
 1st Qu.: 6.00   63     :  25   1st Qu.: 4.000   1   :843   1st Qu.: 7.0  
 Median :11.00   10     :  24   Median : 5.000   NA's:496   Median :12.0  
 Mean   :10.65   15     :  24   Mean   : 5.313              Mean   :11.8  
 3rd Qu.:16.00   4      :  23   3rd Qu.: 6.000              3rd Qu.:16.0  
 Max.   :26.00   21     :  23   Max.   :10.000              Max.   :25.0  
                 (Other):1855   NA's   :516                 NA's   :976   
    popular         popteach     
 Min.   :0.000   Min.   : 1.000  
 1st Qu.:3.900   1st Qu.: 4.000  
 Median :4.800   Median : 5.000  
 Mean   :4.829   Mean   : 4.834  
 3rd Qu.:5.800   3rd Qu.: 6.000  
 Max.   :9.100   Max.   :10.000  
 NA's   :510     NA's   :528     </code></pre>
</div>
</div>
<hr>
<p><strong>9b. The missingness in <code>texp</code> is MNAR: higher values for <code>texp</code> have a larger probability to be missing. Can you see this in the imputed data? Do you think this is a problem?</strong></p>
<p>Yes, we can see this in the imputed data: teacher experience increases slightly after imputation. However, <code>texp</code> is the same for all pupils in a class. But not all pupils have this information recorded (as if some pupils did not remember, or were not present during data collection). This is not a problem, because as long as at least one pupil in each class has teacher experience recorded, we can deductively impute the correct (i.e.&nbsp;true) value for every pupil in the class.</p>
<hr>
<p><strong>10. Compare the ICCs of the variables in the first imputed dataset with those in the incomplete dataset (use <code>popular</code>, <code>popteach</code> and <code>texp</code>). Make a notation of the ICCs after imputation.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">vars =</span> <span class="fu">names</span>(popNCR[<span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">5</span>)]), </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">observed =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, popNCR)), </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, popNCR)), </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, popNCR))), </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">norm     =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, <span class="fu">complete</span>(imp1))), </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, <span class="fu">complete</span>(imp1))), </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, <span class="fu">complete</span>(imp1)))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      vars  observed      norm
1  popular 0.3280070 0.2798518
2 popteach 0.3138658 0.2639095
3     texp 1.0000000 0.4595004</code></pre>
</div>
</div>
<hr>
<p><strong>11. Now impute the <code>popNCR</code> dataset again with <code>mice</code> using imputation method <code>norm</code> for <code>popular</code>, <code>popteach</code>, <code>texp</code> and <code>extrav</code>, but now include <code>class</code> as a predictor</strong> <em>for all variables</em><strong>. Call the <code>mids</code>-object <code>imp2</code>.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> ini<span class="sc">$</span>pred</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>pred[, <span class="st">"pupil"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>imp2 <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR, <span class="at">meth =</span> meth, <span class="at">pred =</span> pred, <span class="at">print =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Number of logged events: 90</code></pre>
</div>
</div>
<hr>
<p><strong>12. Compare the ICCs of the variables in the first imputed dataset from <code>imp2</code> with those of <code>imp1</code> and the incomplete dataset (use <code>popular</code>, <code>popteach</code> and <code>texp</code>). Make a notation of the ICCs after imputation.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">vars =</span> <span class="fu">names</span>(popNCR[<span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">5</span>)]), </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">observed  =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, popNCR)), </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, popNCR)), </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, popNCR))), </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">norm      =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, <span class="fu">complete</span>(imp1))), </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, <span class="fu">complete</span>(imp1))), </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, <span class="fu">complete</span>(imp1)))), </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">normclass =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, <span class="fu">complete</span>(imp2))), </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, <span class="fu">complete</span>(imp2))), </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, <span class="fu">complete</span>(imp2)))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      vars  observed      norm normclass
1  popular 0.3280070 0.2798518 0.3629046
2 popteach 0.3138658 0.2639095 0.3326133
3     texp 1.0000000 0.4595004 1.0000000</code></pre>
</div>
</div>
<p>By simply forcing the algorithm to use the class variable during estimation we adopt a <em>fixed effects approach</em>. This conforms to formulating seperate regression models for each <code>class</code> and imputing within classes from these models.</p>
<hr>
</section>
<section id="checking-convergence-of-the-imputations" class="level3">
<h3 class="anchored" data-anchor-id="checking-convergence-of-the-imputations">Checking Convergence of the imputations</h3>
<hr>
<p><strong>13. Inspect the trace lines for the variables <code>popular</code>, <code>texp</code> and <code>extrav</code>.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp2, <span class="fu">c</span>(<span class="st">"popular"</span>, <span class="st">"texp"</span>, <span class="st">"popteach"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><strong>14. Add another 10 iterations and inspect the trace lines again. What do you observe with respect to the convergence of the sampler?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>imp3 <span class="ot">&lt;-</span> <span class="fu">mice.mids</span>(imp2, <span class="at">maxit =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 iter imp variable
  6   1  extrav  sex  texp  popular  popteach
  6   2  extrav  sex  texp  popular  popteach
  6   3  extrav  sex  texp  popular  popteach
  6   4  extrav  sex  texp  popular  popteach
  6   5  extrav  sex  texp  popular  popteach
  7   1  extrav  sex  texp  popular  popteach
  7   2  extrav  sex  texp  popular  popteach
  7   3  extrav  sex  texp  popular  popteach
  7   4  extrav  sex  texp  popular  popteach
  7   5  extrav  sex  texp  popular  popteach
  8   1  extrav  sex  texp  popular  popteach
  8   2  extrav  sex  texp  popular  popteach
  8   3  extrav  sex  texp  popular  popteach
  8   4  extrav  sex  texp  popular  popteach
  8   5  extrav  sex  texp  popular  popteach
  9   1  extrav  sex  texp  popular  popteach
  9   2  extrav  sex  texp  popular  popteach
  9   3  extrav  sex  texp  popular  popteach
  9   4  extrav  sex  texp  popular  popteach
  9   5  extrav  sex  texp  popular  popteach
  10   1  extrav  sex  texp  popular  popteach
  10   2  extrav  sex  texp  popular  popteach
  10   3  extrav  sex  texp  popular  popteach
  10   4  extrav  sex  texp  popular  popteach
  10   5  extrav  sex  texp  popular  popteach
  11   1  extrav  sex  texp  popular  popteach
  11   2  extrav  sex  texp  popular  popteach
  11   3  extrav  sex  texp  popular  popteach
  11   4  extrav  sex  texp  popular  popteach
  11   5  extrav  sex  texp  popular  popteach
  12   1  extrav  sex  texp  popular  popteach
  12   2  extrav  sex  texp  popular  popteach
  12   3  extrav  sex  texp  popular  popteach
  12   4  extrav  sex  texp  popular  popteach
  12   5  extrav  sex  texp  popular  popteach
  13   1  extrav  sex  texp  popular  popteach
  13   2  extrav  sex  texp  popular  popteach
  13   3  extrav  sex  texp  popular  popteach
  13   4  extrav  sex  texp  popular  popteach
  13   5  extrav  sex  texp  popular  popteach
  14   1  extrav  sex  texp  popular  popteach
  14   2  extrav  sex  texp  popular  popteach
  14   3  extrav  sex  texp  popular  popteach
  14   4  extrav  sex  texp  popular  popteach
  14   5  extrav  sex  texp  popular  popteach
  15   1  extrav  sex  texp  popular  popteach
  15   2  extrav  sex  texp  popular  popteach
  15   3  extrav  sex  texp  popular  popteach
  15   4  extrav  sex  texp  popular  popteach
  15   5  extrav  sex  texp  popular  popteach</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp3, <span class="fu">c</span>(<span class="st">"popular"</span>, <span class="st">"texp"</span>, <span class="st">"popteach"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It seems OK. Adding another 20 iterations confirms this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>imp3b <span class="ot">&lt;-</span> <span class="fu">mice.mids</span>(imp3, <span class="at">maxit =</span> <span class="dv">20</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp3b, <span class="fu">c</span>(<span class="st">"popular"</span>, <span class="st">"texp"</span>, <span class="st">"popteach"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><strong>Further inspection</strong></p>
<p>Several plotting methods based on the package <code>lattice</code> for Trellis graphics are implemented in <code>mice</code> for imputed data.</p>
<hr>
<p><strong>15. Plot the densities of the observed and imputed data (use <code>imp2</code>) with the function <code>densityplot()</code>.</strong></p>
<p>To obtain all densities of the different imputed datasets use</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To obtain just the densities for popular one can use</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp2, <span class="sc">~</span> popular)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>or</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp2, <span class="sc">~</span> popular <span class="sc">|</span> .imp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The latter case results in a conditional plot (conditional on the different imputed datasets).</p>
<hr>
<p><strong>16. Have a look at the imputed dataset by asking the first 15 rows of the first completed dataset for <code>imp2</code>. What do you think of the imputed values?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">complete</span>(imp2, <span class="dv">1</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   pupil class   extrav sex texp  popular popteach
1      1     1 5.000000   1   24 6.300000 6.314991
2      2     1 3.616012   0   24 4.900000 4.343070
3      3     1 4.000000   1   24 5.300000 6.000000
4      4     1 3.000000   0   24 4.700000 5.000000
5      5     1 5.000000   1   24 5.656993 6.000000
6      6     1 3.564456   0   24 4.700000 5.000000
7      7     1 5.000000   0   24 5.900000 5.000000
8      8     1 4.000000   0   24 4.484762 4.389721
9      9     1 5.000000   0   24 4.686309 5.000000
10    10     1 5.000000   0   24 3.900000 3.000000
11    11     1 3.217854   1   24 5.700000 5.000000
12    12     1 5.000000   0   24 4.800000 5.000000
13    13     1 5.000000   0   24 5.000000 5.000000
14    14     1 5.000000   1   24 6.157194 6.000000
15    15     1 5.000000   1   24 6.000000 5.000000</code></pre>
</div>
</div>
<p>or, alternatively</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">complete</span>(imp2, <span class="dv">1</span>), <span class="at">n =</span> <span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   pupil class   extrav sex texp  popular popteach
1      1     1 5.000000   1   24 6.300000 6.314991
2      2     1 3.616012   0   24 4.900000 4.343070
3      3     1 4.000000   1   24 5.300000 6.000000
4      4     1 3.000000   0   24 4.700000 5.000000
5      5     1 5.000000   1   24 5.656993 6.000000
6      6     1 3.564456   0   24 4.700000 5.000000
7      7     1 5.000000   0   24 5.900000 5.000000
8      8     1 4.000000   0   24 4.484762 4.389721
9      9     1 5.000000   0   24 4.686309 5.000000
10    10     1 5.000000   0   24 3.900000 3.000000
11    11     1 3.217854   1   24 5.700000 5.000000
12    12     1 5.000000   0   24 4.800000 5.000000
13    13     1 5.000000   0   24 5.000000 5.000000
14    14     1 5.000000   1   24 6.157194 6.000000
15    15     1 5.000000   1   24 6.000000 5.000000</code></pre>
</div>
</div>
<hr>
<p><strong>17. Impute the <code>popNCR</code> data once more where you use predictive mean matching and include all variables as predictors. Name the object <code>imp4</code>.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>imp4 <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 iter imp variable
  1   1  extrav  sex  texp  popular  popteach
  1   2  extrav  sex  texp  popular  popteach
  1   3  extrav  sex  texp  popular  popteach
  1   4  extrav  sex  texp  popular  popteach
  1   5  extrav  sex  texp  popular  popteach
  2   1  extrav  sex  texp  popular  popteach
  2   2  extrav  sex  texp  popular  popteach
  2   3  extrav  sex  texp  popular  popteach
  2   4  extrav  sex  texp  popular  popteach
  2   5  extrav  sex  texp  popular  popteach
  3   1  extrav  sex  texp  popular  popteach
  3   2  extrav  sex  texp  popular  popteach
  3   3  extrav  sex  texp  popular  popteach
  3   4  extrav  sex  texp  popular  popteach
  3   5  extrav  sex  texp  popular  popteach
  4   1  extrav  sex  texp  popular  popteach
  4   2  extrav  sex  texp  popular  popteach
  4   3  extrav  sex  texp  popular  popteach
  4   4  extrav  sex  texp  popular  popteach
  4   5  extrav  sex  texp  popular  popteach
  5   1  extrav  sex  texp  popular  popteach
  5   2  extrav  sex  texp  popular  popteach
  5   3  extrav  sex  texp  popular  popteach
  5   4  extrav  sex  texp  popular  popteach
  5   5  extrav  sex  texp  popular  popteach</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Number of logged events: 90</code></pre>
</div>
</div>
<hr>
<p><strong>18. Plot again the densities of the observed and imputed data with the function <code>densityplot()</code>, but now use <code>imp4</code>. Is there a difference between the imputations obtained with <code>pmm</code> and <code>norm</code> and can you explain this?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Yes, <code>pmm</code> samples from the observed values and this clearly shows: imputations follow the shape of the observed data.</p>
<hr>
<p><strong>19. Compare the ICCs of the variables in the first imputed dataset from <code>imp4</code> with those of <code>imp1</code>, <code>imp2</code> and the incomplete dataset (use <code>popular</code>, <code>popteach</code> and <code>texp</code>).</strong></p>
<p>See <strong>Exercise 20</strong> for the solution.</p>
<hr>
<p><strong>20. Finally, compare the ICCs of the imputations to the ICCs in the original data. The original data can be found in dataset <code>popular</code>. What do you conclude?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">vars      =</span> <span class="fu">names</span>(popNCR[<span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">5</span>)]), </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">observed  =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, popNCR)), </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, popNCR)), </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, popNCR))), </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">norm      =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, <span class="fu">complete</span>(imp1))), </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, <span class="fu">complete</span>(imp1))), </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, <span class="fu">complete</span>(imp1)))), </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">normclass =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, <span class="fu">complete</span>(imp2))), </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, <span class="fu">complete</span>(imp2))), </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, <span class="fu">complete</span>(imp2)))), </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">pmm       =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> class, <span class="fu">complete</span>(imp4))), </span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> class, <span class="fu">complete</span>(imp4))), </span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> class, <span class="fu">complete</span>(imp4)))), </span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">orig      =</span> <span class="fu">c</span>(<span class="fu">icc</span>(<span class="fu">aov</span>(popular <span class="sc">~</span> <span class="fu">as.factor</span>(class), popular)), </span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(popteach <span class="sc">~</span> <span class="fu">as.factor</span>(class), popular)), </span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">icc</span>(<span class="fu">aov</span>(texp <span class="sc">~</span> <span class="fu">as.factor</span>(class), popular))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      vars  observed      norm normclass       pmm      orig
1  popular 0.3280070 0.2798518 0.3629046 0.3700960 0.3629933
2 popteach 0.3138658 0.2639095 0.3326133 0.3385374 0.3414766
3     texp 1.0000000 0.4595004 1.0000000 1.0000000 1.0000000</code></pre>
</div>
</div>
<p>Note: these display only the first imputed data set.</p>
<hr>
</section>
<section id="changing-the-imputation-method" class="level3">
<h3 class="anchored" data-anchor-id="changing-the-imputation-method">Changing the imputation method</h3>
<p>Mice includes several imputation methods for imputing multilevel data:</p>
<ul>
<li><strong>2l.norm</strong>: Imputes univariate missing data using a two-level normal model with heterogeneous within group variances</li>
<li><strong>2l.pan</strong>: Imputes univariate missing data using a two-level normal model with homogeneous within group variances</li>
<li><strong>2lonly.mean</strong>: Imputes the mean of the class within the class</li>
<li><strong>2lonly.norm</strong>: Imputes univariate missing data at level 2 using Bayesian linear regression analysis</li>
<li><strong>2lonly.pmm</strong>: Imputes univariate missing data at level 2 using predictive mean matching</li>
</ul>
<p>The latter two methods aggregate level 1 variables at level 2, but in combination with <code>mice.impute.2l.pan</code>, allow switching regression imputation between level 1 and level 2 as described in Yucel (2008) or Gelman and Hill (2007, p.&nbsp;541). For more information on these imputation methods see the help.</p>
<hr>
<p><strong>21. Impute the variable <code>popular</code> by means of <code>2l.norm</code>. Use dataset <code>popNCR2</code>.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>ini <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR2, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> ini<span class="sc">$</span>pred</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>pred[<span class="st">"popular"</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the predictor matrix, <code>-2</code> denotes the class variable, a value <code>1</code> indicates a fixed effect and a value <code>2</code> indicates a random effect. However, the currently implemented algorithm does not handle predictors that are specified as fixed effects (type = <code>1</code>). When using <code>mice.impute.2l.norm()</code>, the current advice is to specify all predictors as random effects (type = ``2).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>meth <span class="ot">&lt;-</span> ini<span class="sc">$</span>meth</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>meth <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">"2l.norm"</span>, <span class="st">""</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>imp5 <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR2, <span class="at">pred =</span> pred, <span class="at">meth=</span>meth, <span class="at">print =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>22. Inspect the imputations. Did the algorithm converge?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp5, <span class="sc">~</span>popular, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.35</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp4, <span class="sc">~</span>popular, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.35</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-32-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The imputations generated with <code>2l.norm</code> are very similar to the ones obtained by <code>pmm</code> with <code>class</code> as a fixed effect. If we plot the first imputed dataset from <code>imp4</code> and <code>imp5</code> against the original (true) data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(popular<span class="sc">$</span>popular))  <span class="co">#true data </span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(<span class="fu">complete</span>(imp5)<span class="sc">$</span>popular), <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co">#2l.norm</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(<span class="fu">complete</span>(imp4)<span class="sc">$</span>popular), <span class="at">col =</span> <span class="st">"green"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co">#PMM</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that the imputations are very similar. When studying the convergence</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>we conclude that it may be wise to run additional iterations. Convergence is not apparent from this plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>imp5.b <span class="ot">&lt;-</span> <span class="fu">mice.mids</span>(imp5, <span class="at">maxit =</span> <span class="dv">10</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp5.b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After running another 10 iterations, convergence is more convincing.</p>
<hr>
<p><strong>23. In the original data, the group variances for <code>popular</code> are homogeneous. Use <code>2l.pan</code> to impute the variable <code>popular</code> in dataset <code>popNCR2</code>. Inspect the imputations. Did the algorithm converge?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>ini <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR2, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> ini<span class="sc">$</span>pred</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>pred[<span class="st">"popular"</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>meth <span class="ot">&lt;-</span> ini<span class="sc">$</span>meth</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>meth <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">"2l.pan"</span>, <span class="st">""</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>imp6 <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR2, <span class="at">pred =</span> pred, <span class="at">meth =</span> meth, <span class="at">print =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us create the densityplot for <code>imp6</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp6, <span class="sc">~</span>popular, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.35</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>and compare it to the one for <code>imp4</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp4, <span class="sc">~</span>popular, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.35</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If we plot the first imputed dataset from both objects against the original (true) density, we obtain the following plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(popular<span class="sc">$</span>popular), <span class="at">main =</span> <span class="st">"black = truth | green = PMM | red = 2l.pan"</span>)  <span class="co"># </span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(<span class="fu">complete</span>(imp6)<span class="sc">$</span>popular), <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co">#2l.pan</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(<span class="fu">complete</span>(imp4)<span class="sc">$</span>popular), <span class="at">col =</span> <span class="st">"green"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co">#PMM</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that the imputations are very similar. When studying the convergence</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>we conclude that it may be wise to run additional iterations. Convergence is not apparent from this plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>imp6.b <span class="ot">&lt;-</span> <span class="fu">mice.mids</span>(imp5, <span class="at">maxit =</span> <span class="dv">10</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp6.b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Again, after running another 10 iterations, convergence is more convincing.</p>
<hr>
<p><strong>24. Now inspect dataset <code>popNCR3</code> and impute the incomplete variables according to the following imputation methods:</strong></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">extrav</td>
<td style="text-align: left;">2l.norm</td>
</tr>
<tr class="even">
<td style="text-align: left;">texp</td>
<td style="text-align: left;">2lonly.mean</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sex</td>
<td style="text-align: left;">logreg</td>
</tr>
<tr class="even">
<td style="text-align: left;">popular</td>
<td style="text-align: left;">2l.pan</td>
</tr>
<tr class="odd">
<td style="text-align: left;">popteach</td>
<td style="text-align: left;">2l.pan</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>ini <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR3, <span class="at">maxit =</span> <span class="dv">0</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> ini<span class="sc">$</span>pred</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>pred[<span class="st">"extrav"</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)  <span class="co">#2l.norm</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>pred[<span class="st">"sex"</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)  <span class="co">#2logreg</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>pred[<span class="st">"texp"</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)  <span class="co">#2lonly.mean</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>pred[<span class="st">"popular"</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co">#2l.pan</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>pred[<span class="st">"popteach"</span>, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)  <span class="co">#2l.pan</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>meth <span class="ot">&lt;-</span> ini<span class="sc">$</span>meth</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>meth <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">""</span>, <span class="st">"2l.norm"</span>, <span class="st">"logreg"</span>, <span class="st">"2lonly.mean"</span>, <span class="st">"2l.pan"</span>, <span class="st">"2l.pan"</span>)</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>imp7 <span class="ot">&lt;-</span> <span class="fu">mice</span>(popNCR3, <span class="at">pred =</span> pred, <span class="at">meth =</span> meth, <span class="at">print =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><strong>25. Evaluate the imputations by means of convergence, distributions and plausibility.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Given what we know about the missingness, the imputed densities look very reasonable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-44-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Convergence has not yet been reached. more iterations are advisable.</p>
<hr>
<p><strong>26. Repeat the same imputations as in the previous step, but now use <code>pmm</code> for everything.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>pmmdata <span class="ot">&lt;-</span> popNCR3</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>pmmdata<span class="sc">$</span>class <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(popNCR3<span class="sc">$</span>class)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>imp8 <span class="ot">&lt;-</span> <span class="fu">mice</span>(pmmdata, <span class="at">m =</span> <span class="dv">5</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Number of logged events: 90</code></pre>
</div>
</div>
<p>With <code>pmm</code>, the imputations are very similar and conform to the shape of the observed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When looking at the convergence of <code>pmm</code>, more iterations are advisable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(imp8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Imputing_multilevel_data_files/figure-html/unnamed-chunk-47-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><strong>Conclusions</strong></p>
<p>There are ways to ensure that imputations are not just “guesses of unobserved values”. Imputations can be checked by using a standard of reasonability. We are able to check the differences between observed and imputed values, the differences between their distributions as well as the distribution of the completed data as a whole. If we do this, we can see whether imputations make sense in the context of the problem being studied.</p>
<hr>
<p><strong>References</strong></p>
<p>Gelman, A., &amp; Hill, J. (2006). <em>Data analysis using regression and multilevel/hierarchical models</em>. <a href="http://www.cambridge.org/nl/academic/subjects/statistics-probability/statistical-theory-and-methods/data-analysis-using-regression-and-multilevelhierarchical-models?format=HB&amp;isbn=9780521867061">Cambridge University Press</a>.</p>
<p>Hox, J. J., Moerbeek, M., &amp; van de Schoot, R. (2010). <em>Multilevel analysis: Techniques and applications</em>. <a href="https://www.routledge.com/Multilevel-Analysis-Techniques-and-Applications-Third-Edition/Hox-Moerbeek-Schoot/p/book/9781138121362">Routledge</a>.</p>
<p>Yucel, R. M. (2008). Multiple imputation inference for multivariate multilevel continuous data with ignorable non-response. <em>Philosophical Transactions of the Royal Society of London A: Mathematical, Physical and Engineering Sciences</em>, 366(1874), 2389-2403. <a href="http://rsta.royalsocietypublishing.org/content/366/1874/2389">Article</a></p>
<hr>
<p><strong>- End of Vignette</strong></p>
<hr>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>