<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Thom Benjamin Volker &amp; Gerko Vink">
<meta name="dcterms.date" content="2024-05-17">

<title>Wrapper function futuremice</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Vignette_futuremice_files/libs/clipboard/clipboard.min.js"></script>
<script src="Vignette_futuremice_files/libs/quarto-html/quarto.js"></script>
<script src="Vignette_futuremice_files/libs/quarto-html/popper.min.js"></script>
<script src="Vignette_futuremice_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Vignette_futuremice_files/libs/quarto-html/anchor.min.js"></script>
<link href="Vignette_futuremice_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Vignette_futuremice_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Vignette_futuremice_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Vignette_futuremice_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Vignette_futuremice_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-future-starts-today" id="toc-the-future-starts-today" class="nav-link active" data-scroll-target="#the-future-starts-today">The future starts today</a></li>
  <li><a href="#time-gain-with-small-datasets" id="toc-time-gain-with-small-datasets" class="nav-link" data-scroll-target="#time-gain-with-small-datasets">Time gain with small datasets</a></li>
  <li><a href="#time-gain-with-large-datasets" id="toc-time-gain-with-large-datasets" class="nav-link" data-scroll-target="#time-gain-with-large-datasets">Time gain with large datasets</a></li>
  <li><a href="#default-settings" id="toc-default-settings" class="nav-link" data-scroll-target="#default-settings">Default settings</a></li>
  <li><a href="#using-mice-arguments" id="toc-using-mice-arguments" class="nav-link" data-scroll-target="#using-mice-arguments">Using <code>mice</code> arguments</a></li>
  <li><a href="#argument-n.core" id="toc-argument-n.core" class="nav-link" data-scroll-target="#argument-n.core">Argument <code>n.core</code></a></li>
  <li><a href="#argument-parallelseed" id="toc-argument-parallelseed" class="nav-link" data-scroll-target="#argument-parallelseed">Argument <code>parallelseed</code></a></li>
  <li><a href="#systems-other-than-windows" id="toc-systems-other-than-windows" class="nav-link" data-scroll-target="#systems-other-than-windows">Systems other than Windows</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Vignette_futuremice.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Wrapper function <code>futuremice</code></h1>
<p class="subtitle lead"><strong>Vignette 8 of 10</strong></p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><strong>Thom Benjamin Volker &amp; Gerko Vink</strong> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 17, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>


<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
  }
td {  /* Table  */
  font-size: 16px;
}
h1.title {
  font-size: 28px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 20px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
    font-size: 14px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>
<hr>
<section id="the-future-starts-today" class="level3">
<h3 class="anchored" data-anchor-id="the-future-starts-today">The future starts today</h3>
<p>This is the eighth vignette in a series of ten.</p>
<hr>
<p>For big datasets or high number of imputations, performing multiple imputation with function <code>mice</code> from package <code>mice</code> (Van Buuren &amp; Groothuis-Oudshoorn, 2011) might take a long time. As a solution, wrapper function <code>futuremice</code> was created to enable the imputation procedure to be run in parallel. This is done by dividing the imputations over multiple cores (or CPUs), thus potentially speeding up the process. The function <code>futuremice</code> is a sequel to <code>parlMICE</code> (Schouten &amp; Vink, 2017), developed to improve user-friendliness.</p>
<p>This vignette demonstrates two applications of the <code>futuremice</code> function. The first application shows the tradeoff between time and increasing number of imputations (<span class="math inline">\(m\)</span>) for a small dataset; the second application does the same, but for a relatively large dataset. We also discuss <code>futuremice</code>’s arguments.</p>
<p>The function <code>futuremice</code> depends on packages <code>future</code>, <code>furrr</code> and <code>mice</code>. For more information about running functions in futures, see e.g.&nbsp;<a href="https://cran.r-project.org/web/packages/future/vignettes/future-1-overview.html">the <code>future</code> manual</a> or <a href="https://furrr.futureverse.org/">the <code>furrr</code> manual</a>. Function <code>futuremice</code> found its inspiration from Max’s useful suggestions on parallelization of <code>mice</code>’s chains on <a href="http://stackoverflow.com/questions/24040280/parallel-computation-of-multiple-imputation-by-using-mice-r-package"><code>stackoverflow</code></a>.</p>
<hr>
</section>
<section id="time-gain-with-small-datasets" class="level3">
<h3 class="anchored" data-anchor-id="time-gain-with-small-datasets">Time gain with small datasets</h3>
<p>We demonstrate the potential gain in computing efficiency on simulated data. To this end we sample 1,000 cases from a multivariate normal distribution with mean vector</p>
<p><span class="math display">\[
\mu = \left[\begin{array}
{r}
0 \\
0 \\
0 \\
0
\end{array}\right]
\]</span></p>
<p>and covariance matrix</p>
<p><span class="math display">\[
\Sigma = \left[\begin{array}
{rrrr}
1&amp;0.5&amp;0.5&amp;0.5 \\
0.5&amp;1&amp;0.5&amp;0.5 \\
0.5&amp;0.5&amp;1&amp;0.5 \\
0.5&amp;0.5&amp;0.5&amp;1
\end{array}\right].
\]</span></p>
<p>A MCAR missingness mechanism is imposed on the data where 80 percent of the cases (i.e.&nbsp;rows) has missingness on one variable. All variables have missing values. The missingness is randomly generated with the following arguments from function <a href="https://github.com/RianneSchouten/Amputation_with_Ampute/tree/master/Vignette"><code>mice::ampute</code></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>small_covmat <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">4</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>small_covmat[small_covmat <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>small_data <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1000</span>, </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Sigma =</span> small_covmat)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>small_data_with_missings <span class="ot">&lt;-</span> <span class="fu">ampute</span>(small_data, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">mech =</span> <span class="st">"MCAR"</span>)<span class="sc">$</span>amp</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(small_data_with_missings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]       [,3]       [,4]
[1,] -0.1667048  0.9165856  0.6389869         NA
[2,] -0.4548685  0.4313280         NA  0.5753627
[3,] -1.2432777 -0.4162831 -1.9552769         NA
[4,] -0.1366822         NA -0.5998099  0.7553689
[5,] -1.6633582 -0.7137484  1.8412701  0.1269927
[6,]         NA -1.3018272 -1.4972105 -1.9058145</code></pre>
</div>
</div>
<p>We compare the default ‘sequential’ function <code>mice</code> with function <code>futuremice</code>. In both functions we use the defaults arguments for the <code>mice</code> algorithm, although these could very easily be changed if desired by the user. To demonstrate the increased efficiency when putting more than one computing core to work, we repeat the procedure with <code>futuremice</code> for 1, 2, 3 and 4 cores. Figure 1 shows a graphical representation of the results.</p>
<hr>
<div class="cell" data-hash="Vignette_futuremice_cache/html/unnamed-chunk-3_71982ead0b80a042c63793273e3d5469">
<div class="cell-output-display">
<p><img src="Vignette_futuremice_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p><em>Figure 1. Processing time for small datasets. Multiple imputations are performed with <code>mice</code> (conventional) and wrapper function <code>futureMICE</code> (1, 2, 3 and 4 cores, respectively). The dataset has 1000 cases and 4 variables with a correlation of 0.5. 80 percent of the cases has one missing value based on MCAR missingness.</em></p>
<hr>
<p>It becomes apparent that for a small to moderate number of imputations, the conventional <code>mice</code> function is faster than the wrapper function <code>futuremice</code>. This is the case until the number of imputations <span class="math inline">\(m = 120\)</span>. For higher <span class="math inline">\(m\)</span>, wrapper function <code>futuremice</code> returns the imputations somewhat faster.</p>
<hr>
</section>
<section id="time-gain-with-large-datasets" class="level3">
<h3 class="anchored" data-anchor-id="time-gain-with-large-datasets">Time gain with large datasets</h3>
<p>We replicated the above detailed simulation setup with a larger dataset of 10,000 cases and 8 variables. The mean and covariance structure follow the sampling scheme of the smaller data set. We show the results of this simulation in Figure 2.</p>
<hr>
<div class="cell" data-hash="Vignette_futuremice_cache/html/unnamed-chunk-4_ebacb59aea6ba10e4627839b1c5142b1">
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]       [,3]       [,4]       [,5]       [,6]
[1,] -0.7891224  0.6662847  0.2765961  1.4430855         NA -0.2653717
[2,]  1.2257427  0.7970424  0.7721632  2.5516444  0.8170605  1.0243246
[3,] -0.2922743 -0.6664302 -1.3484499 -0.9736449  0.1881570  0.1598344
[4,] -0.7151888  0.2721259  0.6044130         NA  0.2374834 -0.3803037
[5,] -1.2170593 -1.7371123 -1.1995254 -1.4162931 -0.7217540 -0.9175987
[6,]  0.4221454  0.9604065 -0.3323604  0.1190414  0.2192011  1.0113553
            [,7]        [,8]
[1,]  0.25154854  0.48127292
[2,]  1.12375199          NA
[3,]  0.78083640 -0.07665967
[4,] -0.01697637  1.31384693
[5,] -1.50140012 -0.78570553
[6,] -0.70099336  0.64118618</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Vignette_futuremice_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p><em>Figure 2. Processing time for large datasets. Multiple imputations are performed with <code>mice</code> (conventional) and wrapper function <code>parlMICE</code> (1, 2 and 3 cores respectively). The dataset has 10000 cases and 8 variables with a correlation of 0.5. 80 percent of the cases has one missing value based on MCAR missingness.</em></p>
<hr>
<p>When datasets are sufficiently large, function <code>futuremice</code> works faster than <code>mice</code> for all <span class="math inline">\(m\)</span>. In such cases, even for very small numbers of imputations, running <code>mice</code> in parallel with <code>futuremice</code> saves a significant amount of time. This gain in efficiency can increase to more than 50 percent for <span class="math inline">\(100\)</span> imputations and more.</p>
<p>There is not a large difference between using 2 and 3 cores with wrapper function <code>parlMICE</code>. For all number of imputations, the procedure runs faster with 3 cores, even though the imputations have to be divided over the cores. It might therefore be desirable to use always as many cores as possible, while leaving 1 core out to govern any overhead computing. For example, on a hexacore machine, use only 5 cores to run the <code>mice</code> algorithm in parallel with <code>futuremice</code>.</p>
<hr>
</section>
<section id="default-settings" class="level3">
<h3 class="anchored" data-anchor-id="default-settings">Default settings</h3>
<p>We will now discuss the arguments of function <code>futuremice</code>. Easy imputation of an incomplete dataset (say, <code>nhanes</code>) can be performed with <code>futuremice</code> in the following way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>imp <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(imp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "mids"</code></pre>
</div>
</div>
<p>The function returns a <code>mids</code> object as created by <code>mice</code>. In fact, <code>futuremice</code> makes use of function <code>mice::ibind</code> to combine the <code>mids</code> objects returned by the different cores. Therefore, the <code>call</code> of the <code>mids</code> object has slightly changed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>imp<span class="sc">$</span>call</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
mice(data = data, m = x, printFlag = FALSE, seed = seed)

[[2]]
ibind(x = imp, y = imps[[i]])

[[3]]
ibind(x = imp, y = imps[[i]])

[[4]]
ibind(x = imp, y = imps[[i]])

[[5]]
ibind(x = imp, y = imps[[i]])</code></pre>
</div>
</div>
<p>Additionally, <code>futuremice</code> makes use of a <code>parallelseed</code> argument that is stored in <code>imp$parallelseed</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>imp<span class="sc">$</span>parallelseed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1]       10403         281  1826279530   908648249  1140721631  -260041114
  [7]  -238418316  -670161387  1368457960    36818080  1517725334   493670394
 [13] -1046015996   910574875  -900894818  -121988577  -770718113  1593432097
 [19]   676959770  -616553340 -1470130872 -1446565417  -132614412  -274380591
 [25]  -778085385 -1805085047  -969091378  2036525925   895742532  1808871536
 [31]   701584976  -700062762  1501221314   110839157  1930854003   805632034
 [37] -1285653794 -1893753524  -875495990  -688146030  1222635737  1577067082
 [43]  1155812169   786165877  1051391471   -22253171  1582301439 -1974613530
 [49]   485505778  1645008053  1117942589  1720954067  1054863571 -1278871277
 [55]  1787447610   533071478 -1383885753  -556300963   253036311 -1290237711
 [61]  -180914663  1891422422 -1937364415  -440203668  -374515262  1931393645
 [67] -2134066338  -353506915   430628155   -54861558  -427910818  -967344978
 [73]  -641912556 -1101407715   -54673539 -1997386449   -45540661 -1289228687
 [79]   838071861  -438508778 -1762967452   283247710 -1867693800 -1220938828
 [85]  -307411418 -1775213738  2093658519  1942064081  -421744133  2057771980
 [91] -1102976285  -745602174   109209347  1909425633  -292100485  -495538772
 [97]   211165409  -928828752 -1893393545 -1435230094   302224558  -435607351
[103]  -131101172   365439314  1086838107 -1401663424 -1636085260 -1504115601
[109]  1616140395  1884309273   495201011 -1271482769 -2091178078  -358541243
[115]   325244620  1580267621 -1998187489  1683432317   287336143  -796323459
[121] -1921997928  1721185729  1759135401  1531409850    46772677   -11284143
[127] -1400806398 -1924209435     -153686 -1624252944  1525785776   511649152
[133] -2104979025  -328222935 -1005761241   330025890 -1411239103  1107722648
[139]   675707729   183893510    69810816  -784984921  1990831234   567614780
[145]  -684714589 -1108386374   467574344   977750168  2112532548  1487709490
[151]  1297036034  -698087576   997985539   464404039 -2111167704  1890588090
[157]  2057141364  1954491494 -1595410790 -1198331635  1809398830  1963663165
[163] -1532938292   834217153  1969023887 -2023624635    41161914   911142613
[169]  1103310603   991993959 -1971219504  -783849161   135001165 -1387403550
[175]   308903491  -353872878  2013444360  -279926731 -1553463031  -441303005
[181]  1598263047  -998084496  -568939357   -76269296  -259792902 -1855428781
[187]  1759261231 -2039002260 -1423859890 -1333084794   428670227   147131114
[193]  -436573926  -425623247  2064788009   523632913  1533165803  -117448534
[199]   109554674   616826169 -2103957796  -218961204  -945902714  -472059586
[205]  -723037255  -686238438 -1263370578 -1652753343 -1191402086 -1000185620
[211]  -406913730 -1597827498   558080872  1409351951 -1943565905   542738222
[217] -1183917495 -1432020739  -399177667  -594825952  -332771159 -1209998360
[223]  1437542142   601335496 -1371862787  1312813626  1179892643   556896881
[229]   354729712  1800492169  1118885144   -75576979  -616794688  1397981880
[235]  -116205911   822815511 -1536603803   266368077  -252062349  1763357523
[241] -1625118442   782743259 -2072578095  -638830115   939615483 -1625125164
[247]  1679337509 -1949579802 -1784317896   316425688 -2025942008   -55793990
[253]  -309295799   -36694223  -551160230  1669204210  1610950317  -250635071
[259]   818104202  -722199716 -1709294804 -1929553852   929011857 -1329081435
[265] -1316719377  1135984102 -1646453926  1308496588   -29552366   608448546
[271] -1417886391  1380083943  -434204518  -516997957  1315348291 -2075303777
[277]  -430529001  2018483825   917735788   159669491  -544087038  1504239156
[283] -1190381524   479043166    65897497  1870215697 -1246799042  1085916730
[289]  1823115235  -138067950   189752402 -1445497829  1088486454   315757267
[295]  1922096700   831956766 -1447193383   767522813  -873861189  -612376720
[301] -1900094770 -1332810704  1001818168  1494718475   829099608 -2068775573
[307]  -167672533   624565792 -2022132298  -984570850   -12931190  1394636812
[313]   -55326250  1001818587  2100011930 -2088115513   455606360  -614886963
[319]   156329068  1196848811 -1778284257  1342443593  1639885678  1679580870
[325] -2039638951 -1213176233   737584323    15145250  -175814617   863156081
[331] -1413268217  1617584476  -832599155  1452008509   -29509425   174412409
[337]   -56189475  1485295604  -175169096  -356469771   725641911   142901248
[343]  1748321153  1561635452  1882811264   404110370 -1270692970  1634451532
[349]    -9178760  1612639477  1489666838 -1561552673   245363371   584758234
[355]   451449934  1222858380  1693933778  1622228665   780058131  1584418178
[361]  1615309538 -1971438150  1937163611   511727628  1389889760  1737946546
[367]  1506325313   791296241  1694500862  1309196659    99511954  -324456661
[373]  2126547194 -2006167829 -1688049095 -1870620674   461302341   927445193
[379]  1531545541   861190251 -1608981546 -1533946759   628375338 -1148386980
[385]    40834545 -2087955629  1970823947 -1329615796   937120686   317926319
[391]  1372832798  -255727212  1000736865   793764606  1412072737 -2085595522
[397]  -586227456  1540553555 -1660408140  -993942701   531857878   993590427
[403]  -970370632    50179066  -150739758  -732140920  1299621367  -578392151
[409]  1775000735   219158231  1453567697   748203987   884687381  -827633540
[415]  1566351514 -1179445534   -90606029  -931945183  1695309094  -402413267
[421]  1880158628 -1067613423  -402355528 -1538210900  1343029775   -52208534
[427]  2070852756  1661050232   475595171   118539809   505109426   818100221
[433] -1211962824 -1242073961  1948329808 -2025196266  1953068224  2046167055
[439]  2095629955   447156300  1979439655  1491399536  2089433987  -554706557
[445]   209176772   508808789   610834540   927655264  -154179500 -1872808024
[451]  -638926704    22499991  -931063259  1636279665  2098580108   210244558
[457]  2057420414   -80964611  -987662268    -4046107  1361763662  -987417249
[463]  1847239746    -9459071 -1687420884  2007744977   450163523   320675674
[469]  1273871875  1665884246  -242053373 -1484436231  1830373435  1792844109
[475]   236062234  -972238285  1956168168  1950382085 -1043247556  -202997016
[481]  1797572067  2124605113  1273078164  -940992810   -25241904  1986762505
[487]  1547085229   960214979  -777917759   -42458394   -89858980  -213754766
[493]  -229788778  -232604505 -2025982183  -660686212  1842709363   741565969
[499]   958315958  1564218094    37990238   572281167 -1368221983   119490303
[505] -1854296764 -1925207403  1353194304 -1616572581  1462801647  -590232147
[511]   945259157  1918465969  1987555248 -1562604698  1516727249   168508301
[517]  -114420370    27856226  1442284289  1564468416   849511155     6602604
[523]   476395150  1268671438  -815601167  -426459442  1407418329  1163119494
[529]  -674408417  -587890838 -1492596876  1696669262   579750152  1066387763
[535]  1109784416   598076172 -1255051777  1455273521   124378295 -1525774165
[541]   796201745   643976450  1139803102   362419533  1978075378  1252517828
[547]   -32441466 -1431187988  1494956513  -360756004  2044804659  1995679606
[553]  -536635963  1627753001  -736041185  -303757793  1384528899   398637101
[559]   202791041   948067079 -1780261345  1044757775  -876884095  1548648081
[565]  1597259326 -1523639687  -289073412  -815427273 -1543950960  1998690723
[571]  1519425744  -950312124 -1016614987   587488002   505705088 -2130489418
[577] -1928263486 -1341066775  1747615296   575352457   624767442  1772551357
[583] -1090911944   407237273  1784976830 -1310917877   522708735  1868387969
[589]    96604843   454596834  1323212855  -871416606   469166058 -1185774481
[595]  1016443457  1102892260  -543768582 -1114984384  1882839954 -1243975291
[601]   707250831   467295297 -1144670459  1207887677  1123511782 -2012791518
[607]   -45889929  1382249588  1427909629 -1520385285 -2130714530  -958704059
[613]  1086985376  1754630543   536386164  1012748109  -758590104  1656501370
[619]   609683540   187882649   387960510  1003551871  1010792375  -170541339
[625]  1519158362  -345684351</code></pre>
</div>
</div>
<p>If no seed is specified by the user, a seed will be drawn randomly from a uniform distribution <span class="math inline">\(U(-999999999,999999999)\)</span>, and this seed will be returned, such that the user can reproduce the obtained results even when no seed is specified. See section <a href="#argument-parallelseed">Argument <code>parallelseed</code></a> for more information.</p>
<p>All other parts of the <code>mids</code> object are standard.</p>
<hr>
</section>
<section id="using-mice-arguments" class="level3">
<h3 class="anchored" data-anchor-id="using-mice-arguments">Using <code>mice</code> arguments</h3>
<p>Function <code>futuremice</code> is able to deal with the conventional <code>mice</code> arguments. In order to change the imputation method from its default (predictive mean matching) to, for example, Bayesian linear regression, the <code>method</code> argument can be adjusted. For other possibilities with <code>mice</code>, we refer to the <code>mice</code> <a href="https://cran.r-project.org/web/packages/mice/mice.pdf">manual</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>imp <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes, <span class="at">method =</span> <span class="st">"norm"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>imp<span class="sc">$</span>method</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   age    bmi    hyp    chl 
    "" "norm" "norm" "norm" </code></pre>
</div>
</div>
<p>In <code>mice</code>, the number of imputations is specified with argument <code>m</code>. In <code>futuremice</code>, the same argument should be used, and <code>futuremice</code> takes care of dividing the imputations equally over the cores. The next section discusses these arguments.</p>
<hr>
</section>
<section id="argument-n.core" class="level3">
<h3 class="anchored" data-anchor-id="argument-n.core">Argument <code>n.core</code></h3>
<p>With <code>n.core</code>, the number of cores (or CPUs) is given, and the number of imputations <code>m</code> is (about) equally distributed over the cores.</p>
<p>As a default, <code>n.core</code> is specified as the number of available, logical cores minus 1. The default number of imputations has been set to <code>m = 5</code>, just as in a regular <code>mice</code> call. Hence, on machines with 4 available, logical cores, <span class="math inline">\(5\)</span> imputations are divided over 3 cores, leaving 1 core available for any overhead computations. This results in a number of imputations per core of: <span class="math inline">\(core1, core1, core2, core3, core3\)</span>, respectively.</p>
<p>The computer with which this vignette is run, has</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>parallelly<span class="sc">::</span><span class="fu">availableCores</span>(<span class="at">logical =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>system 
     8 </code></pre>
</div>
</div>
<p>available, logical cores. Accordingly, the number of imputations per core equals core1, core1, core2, core3, core3 We can check this by evaluating the <span class="math inline">\(m\)</span> that is shown in the <code>mids</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>imp<span class="sc">$</span>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="argument-parallelseed" class="level3">
<h3 class="anchored" data-anchor-id="argument-parallelseed">Argument <code>parallelseed</code></h3>
<p>In simulation studies, it is often desired to set a seed to make the results reproducible. Similarly to <code>mice</code>, the seed value for <code>futuremice</code> can be defined outside the function. Under the hood, <code>futuremice</code> makes use of the <code>furrr::furrr_options(seed = TRUE)</code> argument, which recognizes that a seed has been specified in the global environment. Hence users can specify the following code to obtain identical results.</p>
<div class="cell" data-warnings="false" data-hash="Vignette_futuremice_cache/html/unnamed-chunk-11_30bde93a3d3bafc1a88ef18724441b83">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'magrittr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    set_names</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>imp1 <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes, <span class="at">n.core =</span> <span class="dv">3</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>imp2 <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes, <span class="at">n.core =</span> <span class="dv">3</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>imp1 <span class="sc">%$%</span> <span class="fu">lm</span>(chl <span class="sc">~</span> bmi) <span class="sc">%&gt;%</span> pool <span class="sc">%$%</span> pooled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         term m   estimate       ubar          b          t dfcom       df
1 (Intercept) 5 129.350091 3029.97733 798.544710 3988.23098    23 13.08385
2         bmi 5   2.439893    4.20187   1.086733    5.50595    23 13.20235
        riv    lambda       fmi
1 0.3162577 0.2402703 0.3347415
2 0.3103571 0.2368492 0.3310517</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>imp2 <span class="sc">%$%</span> <span class="fu">lm</span>(chl <span class="sc">~</span> bmi) <span class="sc">%&gt;%</span> pool <span class="sc">%$%</span> pooled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         term m   estimate       ubar          b          t dfcom       df
1 (Intercept) 5 129.350091 3029.97733 798.544710 3988.23098    23 13.08385
2         bmi 5   2.439893    4.20187   1.086733    5.50595    23 13.20235
        riv    lambda       fmi
1 0.3162577 0.2402703 0.3347415
2 0.3103571 0.2368492 0.3310517</code></pre>
</div>
</div>
<p>A user can also specify a seed within the <code>futuremice</code> call, by specifying the argument <code>parallelseed</code>. This seed is parsed to <code>withr::local_seed()</code>, such that the global environment is not affected by a different seed within the <code>futuremice</code> function. Hence, users can also specify a seed as follows.</p>
<div class="cell" data-hash="Vignette_futuremice_cache/html/unnamed-chunk-12_c989fecb4f0312e1b596dee36554ed54">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>imp3 <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes, <span class="at">parallelseed =</span> <span class="dv">123</span>, <span class="at">n.core =</span> <span class="dv">3</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>imp4 <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes, <span class="at">parallelseed =</span> <span class="dv">123</span>, <span class="at">n.core =</span> <span class="dv">3</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>imp3 <span class="sc">%$%</span> <span class="fu">lm</span>(chl <span class="sc">~</span> bmi) <span class="sc">%&gt;%</span> pool <span class="sc">%$%</span> pooled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         term m   estimate       ubar          b          t dfcom       df
1 (Intercept) 5 129.350091 3029.97733 798.544710 3988.23098    23 13.08385
2         bmi 5   2.439893    4.20187   1.086733    5.50595    23 13.20235
        riv    lambda       fmi
1 0.3162577 0.2402703 0.3347415
2 0.3103571 0.2368492 0.3310517</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>imp4 <span class="sc">%$%</span> <span class="fu">lm</span>(chl <span class="sc">~</span> bmi) <span class="sc">%&gt;%</span> pool <span class="sc">%$%</span> pooled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         term m   estimate       ubar          b          t dfcom       df
1 (Intercept) 5 129.350091 3029.97733 798.544710 3988.23098    23 13.08385
2         bmi 5   2.439893    4.20187   1.086733    5.50595    23 13.20235
        riv    lambda       fmi
1 0.3162577 0.2402703 0.3347415
2 0.3103571 0.2368492 0.3310517</code></pre>
</div>
</div>
<p>This also yields identical results for <code>imp3</code> and <code>imp4</code>. However, note that this does <strong>not</strong> result in the exact same imputations as the procedure where the seed is specified in the global environment.</p>
<p>If no seed is specified in the global environment, or in the call itself, the results are still reproducible, because in such circumstances, <code>futuremice</code> randomly draws a seed from a uniform distribution <span class="math inline">\(U(-999999999,999999999)\)</span>. This randomly drawn seed is stored under <code>$parallelseed</code> in the output object, such that reproducible results can be obtained as follows.</p>
<div class="cell" data-hash="Vignette_futuremice_cache/html/unnamed-chunk-13_9316e0b5dbb00e298d0f38fed871d45c">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>imp5 <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes, <span class="at">n.core =</span> <span class="dv">3</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>parallelseed <span class="ot">&lt;-</span> imp5<span class="sc">$</span>parallelseed[<span class="dv">1</span>]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>imp6 <span class="ot">&lt;-</span> <span class="fu">futuremice</span>(nhanes, <span class="at">parallelseed =</span> parallelseed, <span class="at">n.core =</span> <span class="dv">3</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>imp5 <span class="sc">%$%</span> <span class="fu">lm</span>(chl <span class="sc">~</span> bmi) <span class="sc">%&gt;%</span> pool <span class="sc">%$%</span> pooled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         term m   estimate        ubar           b           t dfcom       df
1 (Intercept) 5 114.773367 3003.784878 679.3464599 3819.000630    23 14.02992
2         bmi 5   3.047209    4.215382   0.6232608    4.963295    23 16.35719
        riv    lambda       fmi
1 0.2713962 0.2134631 0.3058343
2 0.1774247 0.1506888 0.2384403</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>imp6 <span class="sc">%$%</span> <span class="fu">lm</span>(chl <span class="sc">~</span> bmi) <span class="sc">%&gt;%</span> pool <span class="sc">%$%</span> pooled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         term m  estimate        ubar           b           t dfcom       df
1 (Intercept) 5 123.52773 3273.760850 1170.967485 4678.921832    23 11.12769
2         bmi 5   2.68347    4.548798    1.763287    6.664742    23 10.61455
        riv    lambda       fmi
1 0.4292192 0.3003173 0.3993685
2 0.4651656 0.3174833 0.4177461</code></pre>
</div>
</div>
<p><strong>WARNING:</strong> Under unique circumstances, users might want to check whether imputations obtained under different streams are identical. This can be done by specifying the regular <code>seed</code> argument in the <code>futuremice</code> call. This seed is parsed to the separate <code>mice</code> calls within all futures, such that the results will be identical over the cores. If users specify the <code>seed</code> argument rather than the <code>parallelseed</code> argument, <code>futuremice</code> will ask if this is intended behavior if the user is in an <code>interactive()</code> session. Otherwise, a warning will be printed.</p>
<hr>
</section>
<section id="systems-other-than-windows" class="level3">
<h3 class="anchored" data-anchor-id="systems-other-than-windows">Systems other than Windows</h3>
<p>Function <code>futuremice</code> calls for function <code>future_map</code> with <code>plan("multisession")</code> from the <code>furrr</code> <a href="https://furrr.futureverse.org/">package</a>. Although other options are available, we have chosen for the <code>plan("multisession")</code> because it allows for the use of multiple cores on all computers, including a Windows computer. The user may adjust this by specifying the <code>future.plan</code> argument within <code>futuremice</code>. Other options are for example <code>future.plan = "multicore"</code>, which results in <code>plan("multicore")</code> (which is not supported on Windows computers), <code>future.plan = "cluster"</code>, resulting in <code>plan("cluster")</code>. For all options regarding <code>plan()</code>, check <code>?future::plan()</code>.</p>
<hr>
</section>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References</h3>
<p>Manual <code>R</code>-package <code>future</code>, available at <a href="https://cran.r-project.org/web/packages/future/future.pdf">https://cran.r-project.org/web/packages/future/future.pdf</a></p>
<p>Manual <code>R</code>-package <code>furrr</code>, available at <a href="https://cran.r-project.org/web/packages/furrr/furrr.pdf">https://cran.r-project.org/web/packages/furrr/furrr.pdf</a></p>
<p>Manual package <code>MICE</code>, available at <a href="https://cran.r-project.org/web/packages/mice/mice.pdf">https://cran.r-project.org/web/packages/mice/mice.pdf</a></p>
<p>Schouten, R.M., Lugtig, P.J. and Vink, G. (2016). Multiple amputation using ampute [manual]. Available at <a href="https://github.com/RianneSchouten/mice/blob/ampute/vignettes/Vignette_Ampute.pdf">https://github.com/RianneSchouten/mice/blob/ampute/vignettes/Vignette_Ampute.pdf</a></p>
<p>Schouten, R.M. and Vink, G. (2017). parlmice: faster, paraleller, micer. <a href="https://www.gerkovink.com/parlMICE/Vignette_parlMICE.html">https://www.gerkovink.com/parlMICE/Vignette_parlMICE.html</a></p>
<p>Van Buuren, S. and Groothuis-Oudshoorn, K. (2011). mice: Multivariate imputation by chained equations in R. <em>Journal of Statistical Software, 45 (3)</em>, 1-67.</p>
<hr>
<p><strong>End of Vignette</strong></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>